name: Discord Update Notification

on:
  push:
    branches: [main]
    paths:
      - 'script/aimbot'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          # â”€â”€ Commit Info â”€â”€
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"

          # Version from hash
          HASH_NUM=$((16#${COMMIT_SHA:0:4} % 1000))
          VERSION="v6.${HASH_NUM}"

          # â”€â”€ Line Changes â”€â”€
          PARENT_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          LINE_INFO="Unknown"
          if [ -n "$PARENT_SHA" ]; then
            STATS=$(git diff --numstat "$PARENT_SHA" HEAD -- script/aimbot 2>/dev/null | awk '{print $1, $2}')
            if [ -n "$STATS" ]; then
              INS=$(echo "$STATS" | awk '{print $1}')
              DEL=$(echo "$STATS" | awk '{print $2}')
              LINE_INFO="+${INS} / -${DEL} lines"
            fi
          fi

          # â”€â”€ Auto-Detect Changes from Commit Message â”€â”€
          # Write commits like: "Add Kill Aura, update ESP, fix tracer lag"
          # Or: "New: Streamer Mode, Profile System | Fix: skeleton ESP"
          CHANGES=""

          # Extract features from commit message
          FEATURES=$(echo "$COMMIT_MSG" | grep -oiP "(?:add|new|update|improve|rework|fix|remove|tweak|buff|nerf|rework)[:\s]+[^,.|]+" 2>/dev/null | head -8 || true)
          if [ -n "$FEATURES" ]; then
            while IFS= read -r feat; do
              if [ -n "$feat" ]; then
                # Capitalize first letter and clean up
                CLEAN=$(echo "$feat" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                ICON="ğŸ”§"
                echo "$CLEAN" | grep -qiP "^(add|new)" && ICON="âœ¨"
                echo "$CLEAN" | grep -qiP "^fix" && ICON="ğŸ›"
                echo "$CLEAN" | grep -qiP "^remove" && ICON="ğŸ—‘ï¸"
                echo "$CLEAN" | grep -qiP "^(update|improve|rework|tweak)" && ICON="âš¡"
                CHANGES="${CHANGES}${ICON} ${CLEAN}\n"
              fi
            done <<< "$FEATURES"
          fi

          # If no parseable features, just show commit message
          if [ -z "$CHANGES" ]; then
            CHANGES="ğŸ”§ ${COMMIT_MSG}"
          fi

          # â”€â”€ Obfuscation Check â”€â”€
          OBF_STATUS="âŒ Raw"
          FIRST_LINE=$(head -c 200 script/aimbot 2>/dev/null || echo "")
          if echo "$FIRST_LINE" | grep -qiP "wearedevs|obfuscat"; then
            OBF_STATUS="ğŸ”’ JJSploit"
          elif echo "$FIRST_LINE" | grep -qiP "return\(function"; then
            OBF_STATUS="ğŸ”’ Obfuscated"
          fi

          # â”€â”€ Truncate safety â”€â”€
          if [ ${#CHANGES} -gt 600 ]; then
            CHANGES="${CHANGES:0:580}\\n..."
          fi

          # â”€â”€ Send Embed â”€â”€
          PAYLOAD=$(cat <<EOF
          {
            "username": "Binxix Hub V6",
            "embeds": [{
              "title": "ğŸš€ Binxix Hub V6 â€” ${VERSION}",
              "url": "${COMMIT_URL}",
              "color": 10181558,
              "description": "**${COMMIT_MSG}**\n\n${CHANGES}\n\nğŸ“„ \`script/aimbot\` â€” ${LINE_INFO}",
              "fields": [
                {
                  "name": "Version",
                  "value": "\`${VERSION}\`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[\`${SHORT_SHA}\`](${COMMIT_URL})",
                  "inline": true
                },
                {
                  "name": "Status",
                  "value": "${OBF_STATUS}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "Binxix Hub Updates â€¢ ${AUTHOR}"
              },
              "timestamp": "${TIMESTAMP}"
            }]
          }
          EOF
          )

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK")

          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Discord notification sent!"
          else
            echo "âš ï¸ HTTP $HTTP_CODE â€” sending fallback"
            FALLBACK='{"username":"Binxix Hub V6","content":"ğŸš€ **Update '"${VERSION}"'** â€” '"${COMMIT_MSG}"'\nğŸ”— '"${COMMIT_URL}"'"}'
            curl -s -H "Content-Type: application/json" -d "$FALLBACK" "$DISCORD_WEBHOOK"
            echo "âœ… Fallback sent"
          fi
