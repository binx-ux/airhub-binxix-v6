name: Discord Update Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          # â”€â”€ Commit Info â”€â”€
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"
          HASH_NUM=$((16#${COMMIT_SHA:0:4} % 1000))
          VERSION="v6.${HASH_NUM}"

          PARENT_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # FIND THE MAIN LUA SOURCE FILE
          # Priority: source/*.lua > src/*.lua > *.lua in root
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          SOURCE_FILE=""
          for pattern in "source/*.lua" "src/*.lua" "*.lua"; do
            for f in $pattern; do
              if [ -f "$f" ]; then
                SOURCE_FILE="$f"
                break 2
              fi
            done
          done

          CHANGES=""
          STATS_LINE=""

          if [ -n "$SOURCE_FILE" ] && [ -n "$PARENT_SHA" ]; then
            # Check if this file actually changed
            if git diff --name-only "$PARENT_SHA" HEAD | grep -qF "$SOURCE_FILE"; then

              # â”€â”€ Line stats â”€â”€
              INS=$(git diff --numstat "$PARENT_SHA" HEAD -- "$SOURCE_FILE" | awk '{print $1}')
              DEL=$(git diff --numstat "$PARENT_SHA" HEAD -- "$SOURCE_FILE" | awk '{print $2}')
              STATS_LINE="ğŸ“„ \`${SOURCE_FILE}\` â€” **+${INS:-0}** / **-${DEL:-0}** lines"

              # Get only added lines (lines starting with +, skip +++ header)
              ADDED_LINES=$(git diff "$PARENT_SHA" HEAD -- "$SOURCE_FILE" | grep "^+" | grep -v "^+++" || true)
              # Get only removed lines
              REMOVED_LINES=$(git diff "$PARENT_SHA" HEAD -- "$SOURCE_FILE" | grep "^-" | grep -v "^---" || true)

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW GAMES ADDED
              # Looks for: [placeId] = {name = "GameName"
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_GAMES=$(echo "$ADDED_LINES" | grep -oP '\{name\s*=\s*"\K[^"]+' 2>/dev/null | head -5 || true)
              if [ -n "$NEW_GAMES" ]; then
                GAME_LIST=""
                while IFS= read -r g; do
                  [ -n "$g" ] && GAME_LIST="${GAME_LIST}\`${g}\` "
                done <<< "$NEW_GAMES"
                [ -n "$GAME_LIST" ] && CHANGES="${CHANGES}ğŸ® **New Games:** ${GAME_LIST}\n"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW FUNCTIONS
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_FUNCS=$(echo "$ADDED_LINES" | grep -oP '(?:local\s+)?function\s+\K\w+' 2>/dev/null | sort -u | head -10 || true)
              if [ -n "$NEW_FUNCS" ]; then
                FUNC_LIST=""
                while IFS= read -r f; do
                  [ -n "$f" ] && FUNC_LIST="${FUNC_LIST}\`${f}\` "
                done <<< "$NEW_FUNCS"
                [ -n "$FUNC_LIST" ] && CHANGES="${CHANGES}ğŸ†• **New Functions:** ${FUNC_LIST}\n"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # REMOVED FUNCTIONS
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              REMOVED_FUNCS=$(echo "$REMOVED_LINES" | grep -oP '(?:local\s+)?function\s+\K\w+' 2>/dev/null | sort -u | head -10 || true)
              if [ -n "$REMOVED_FUNCS" ]; then
                ACTUALLY_REMOVED=""
                while IFS= read -r rf; do
                  if [ -n "$rf" ] && ! echo "$NEW_FUNCS" | grep -qxF "$rf"; then
                    ACTUALLY_REMOVED="${ACTUALLY_REMOVED}\`${rf}\` "
                  fi
                done <<< "$REMOVED_FUNCS"
                [ -n "$ACTUALLY_REMOVED" ] && CHANGES="${CHANGES}ğŸ—‘ï¸ **Removed Functions:** ${ACTUALLY_REMOVED}\n"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW SETTINGS / CONFIG VALUES
              # Looks for indented: SettingName = value,
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_SETTINGS=$(echo "$ADDED_LINES" | grep -P '^\+\s{4,}\w+\s*=' 2>/dev/null | grep -oP '^\+\s+\K\w+' 2>/dev/null | sort -u | head -12 || true)
              if [ -n "$NEW_SETTINGS" ]; then
                SETTING_LIST=""
                COUNT=0
                while IFS= read -r s; do
                  if [ -n "$s" ] && [[ ! "$s" =~ ^(local|if|for|while|end|return|then|else|elseif|do|function|true|false|nil|Size|Position|Parent|Text|Name|BackgroundColor3|TextColor3|BorderSizePixel|Font|TextSize)$ ]]; then
                    SETTING_LIST="${SETTING_LIST}\`${s}\` "
                    COUNT=$((COUNT + 1))
                    [ $COUNT -ge 10 ] && break
                  fi
                done <<< "$NEW_SETTINGS"
                [ -n "$SETTING_LIST" ] && CHANGES="${CHANGES}âš™ï¸ **New Settings:** ${SETTING_LIST}\n"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW GUI ELEMENTS
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_CHECKBOXES=$(echo "$ADDED_LINES" | grep -oP 'createCheckbox\(\w+,\s*"\K[^"]+' 2>/dev/null | head -8 || true)
              if [ -n "$NEW_CHECKBOXES" ]; then
                CB_LIST=""
                while IFS= read -r cb; do
                  [ -n "$cb" ] && CB_LIST="${CB_LIST}â€¢ ${cb}\n"
                done <<< "$NEW_CHECKBOXES"
                [ -n "$CB_LIST" ] && CHANGES="${CHANGES}âœ… **New Toggles:**\n${CB_LIST}"
              fi

              NEW_SLIDERS=$(echo "$ADDED_LINES" | grep -oP 'createSlider\(\w+,\s*"\K[^"]+' 2>/dev/null | head -6 || true)
              if [ -n "$NEW_SLIDERS" ]; then
                SL_LIST=""
                while IFS= read -r sl; do
                  [ -n "$sl" ] && SL_LIST="${SL_LIST}â€¢ ${sl}\n"
                done <<< "$NEW_SLIDERS"
                [ -n "$SL_LIST" ] && CHANGES="${CHANGES}ğŸšï¸ **New Sliders:**\n${SL_LIST}"
              fi

              NEW_DROPDOWNS=$(echo "$ADDED_LINES" | grep -oP 'createDropdown\(\w+,\s*"\K[^"]+' 2>/dev/null | head -4 || true)
              if [ -n "$NEW_DROPDOWNS" ]; then
                DD_LIST=""
                while IFS= read -r dd; do
                  [ -n "$dd" ] && DD_LIST="${DD_LIST}â€¢ ${dd}\n"
                done <<< "$NEW_DROPDOWNS"
                [ -n "$DD_LIST" ] && CHANGES="${CHANGES}ğŸ“‹ **New Dropdowns:**\n${DD_LIST}"
              fi

              NEW_SECTIONS=$(echo "$ADDED_LINES" | grep -oP 'createSectionHeader\(\w+,\s*"\K[^"]+' 2>/dev/null | head -5 || true)
              if [ -n "$NEW_SECTIONS" ]; then
                SEC_LIST=""
                while IFS= read -r sec; do
                  [ -n "$sec" ] && SEC_LIST="${SEC_LIST}\`${sec}\` "
                done <<< "$NEW_SECTIONS"
                [ -n "$SEC_LIST" ] && CHANGES="${CHANGES}ğŸ“‚ **New Sections:** ${SEC_LIST}\n"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW THEMES
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              if echo "$ADDED_LINES" | grep -qP "Background\s*=\s*Color3"; then
                NEW_THEMES=$(echo "$ADDED_LINES" | grep -oP '^\+\s{4}\K\w+(?=\s*=\s*\{)' 2>/dev/null | head -5 || true)
                if [ -n "$NEW_THEMES" ]; then
                  THEME_LIST=""
                  while IFS= read -r t; do
                    [ -n "$t" ] && THEME_LIST="${THEME_LIST}\`${t}\` "
                  done <<< "$NEW_THEMES"
                  [ -n "$THEME_LIST" ] && CHANGES="${CHANGES}ğŸ¨ **New Themes:** ${THEME_LIST}\n"
                fi
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # WIP FLAGS
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_WIP=$(echo "$ADDED_LINES" | grep -c 'wip\s*=\s*true' 2>/dev/null || echo "0")
              [ "$NEW_WIP" -gt 0 ] && CHANGES="${CHANGES}ğŸš§ **WIP flags added:** ${NEW_WIP} game(s)\n"

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # EXTERNAL SCRIPT LINKS
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_LOADSCRIPT=$(echo "$ADDED_LINES" | grep -oP 'loadScript\s*=\s*"\K[^"]+' 2>/dev/null | head -3 || true)
              if [ -n "$NEW_LOADSCRIPT" ]; then
                LS_LIST=""
                while IFS= read -r ls; do
                  [ -n "$ls" ] && LS_LIST="${LS_LIST}â€¢ \`${ls}\`\n"
                done <<< "$NEW_LOADSCRIPT"
                [ -n "$LS_LIST" ] && CHANGES="${CHANGES}ğŸ“œ **New External Scripts:**\n${LS_LIST}"
              fi

              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              # NEW EVENT CONNECTIONS (if significant)
              # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              NEW_CONNS=$(echo "$ADDED_LINES" | grep -c ":Connect(function" 2>/dev/null || echo "0")
              [ "$NEW_CONNS" -gt 3 ] && CHANGES="${CHANGES}âš¡ **New event hooks:** ${NEW_CONNS} connections\n"

            else
              STATS_LINE="ğŸ“„ \`${SOURCE_FILE}\` â€” no changes"
            fi
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ALSO CHECK script/* (obfuscated builds)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          OBF_CHANGES=""
          if [ -n "$PARENT_SHA" ]; then
            for FILE in $(git diff --name-only "$PARENT_SHA" HEAD 2>/dev/null); do
              if [[ "$FILE" == script/* ]]; then
                OBF_INS=$(git diff --numstat "$PARENT_SHA" HEAD -- "$FILE" | awk '{print $1}')
                OBF_DEL=$(git diff --numstat "$PARENT_SHA" HEAD -- "$FILE" | awk '{print $2}')
                OBF_TAG=""
                if [ -f "$FILE" ]; then
                  FIRST=$(head -c 200 "$FILE" 2>/dev/null || echo "")
                  if echo "$FIRST" | grep -qiP "wearedevs|obfuscat"; then
                    OBF_TAG=" ğŸ”’ JJSploit"
                  elif echo "$FIRST" | grep -qiP "return\(function"; then
                    OBF_TAG=" ğŸ”’ Obfuscated"
                  fi
                fi
                OBF_CHANGES="${OBF_CHANGES}ğŸ“¦ \`${FILE}\` â€” +${OBF_INS:-0} / -${OBF_DEL:-0}${OBF_TAG}\n"
              fi
            done
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # BUILD DESCRIPTION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          DESC="**${COMMIT_MSG}**\n"

          [ -n "$STATS_LINE" ] && DESC="${DESC}\n${STATS_LINE}\n"
          [ -n "$OBF_CHANGES" ] && DESC="${DESC}${OBF_CHANGES}"
          [ -n "$CHANGES" ] && DESC="${DESC}\n${CHANGES}"

          # If nothing detected at all
          if [ -z "$STATS_LINE" ] && [ -z "$OBF_CHANGES" ] && [ -z "$CHANGES" ]; then
            DESC="${DESC}\nğŸ”§ Config/docs update"
          fi

          # Truncate for Discord 4096 char embed limit
          if [ ${#DESC} -gt 3800 ]; then
            DESC="${DESC:0:3750}\n\n... and more"
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # SEND TO DISCORD
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PAYLOAD=$(cat <<EOF
          {
            "username": "Binxix Hub V6",
            "embeds": [{
              "title": "ğŸš€ Binxix Hub V6 â€” ${VERSION}",
              "url": "${COMMIT_URL}",
              "color": 10181558,
              "description": "${DESC}",
              "fields": [
                {
                  "name": "Version",
                  "value": "\`${VERSION}\`",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[\`${SHORT_SHA}\`](${COMMIT_URL})",
                  "inline": true
                },
                {
                  "name": "Pushed by",
                  "value": "${AUTHOR}",
                  "inline": true
                }
              ],
              "footer": {
                "text": "Binxix Hub Updates â€¢ ${REPO}"
              },
              "timestamp": "${TIMESTAMP}"
            }]
          }
          EOF
          )

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK")

          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Discord notification sent!"
          else
            echo "âš ï¸ HTTP $HTTP_CODE â€” sending fallback"
            FALLBACK='{"username":"Binxix Hub V6","content":"ğŸš€ **Update '"${VERSION}"'** â€” '"${COMMIT_MSG}"'\nğŸ”— '"${COMMIT_URL}"'"}'
            curl -s -H "Content-Type: application/json" -d "$FALLBACK" "$DISCORD_WEBHOOK"
            echo "âœ… Fallback sent"
          fi
