name: Discord Update Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Get commit info
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"
          
          # Generate version number from SHA
          HASH_NUM=$((16#${COMMIT_SHA:0:4} % 1000))
          VERSION="v6.${HASH_NUM}"
          
          # Count changed files
          ADDED=$(echo '${{ toJSON(github.event.head_commit.added) }}' | jq 'length')
          MODIFIED=$(echo '${{ toJSON(github.event.head_commit.modified) }}' | jq 'length')
          REMOVED=$(echo '${{ toJSON(github.event.head_commit.removed) }}' | jq 'length')
          
          # Build changelog from all commits in push
          CHANGELOG=""
          COMMIT_COUNT=0
          while IFS= read -r line; do
            SHA=$(echo "$line" | jq -r '.id' 2>/dev/null)
            MSG=$(echo "$line" | jq -r '.message' 2>/dev/null | head -1)
            URL=$(echo "$line" | jq -r '.url' 2>/dev/null)
            if [ "$SHA" != "null" ] && [ -n "$SHA" ]; then
              SHORT="${SHA:0:7}"
              if [ $COMMIT_COUNT -eq 0 ]; then
                CHANGELOG="${CHANGELOG}ðŸ”¥ [\`${SHORT}\`](${URL}) â€” ${MSG}\n"
              else
                CHANGELOG="${CHANGELOG}â€¢ [\`${SHORT}\`](${URL}) â€” ${MSG}\n"
              fi
              COMMIT_COUNT=$((COMMIT_COUNT + 1))
            fi
          done < <(echo '${{ toJSON(github.event.commits) }}' | jq -c '.[]')
          
          # Fallback if changelog is empty
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="ðŸ”¥ [\`${SHORT_SHA}\`](${COMMIT_URL}) â€” ${COMMIT_MSG}"
            COMMIT_COUNT=1
          fi
          
          # Build the Discord embed payload
          PAYLOAD=$(cat <<EOF
          {
            "username": "Binxix Hub V6",
            "embeds": [{
              "title": "ðŸ“¦ Binxix Hub V6 â€” Update ${VERSION}",
              "url": "${COMMIT_URL}",
              "color": 10181558,
              "description": "### Latest Commit\n**${COMMIT_MSG}**\n",
              "fields": [
                {
                  "name": "ðŸ“‹ Changelog",
                  "value": "${CHANGELOG}",
                  "inline": false
                },
                {
                  "name": "ðŸ“ File Changes",
                  "value": "âœ… ${ADDED} added  â€¢  âœï¸ ${MODIFIED} modified  â€¢  ðŸ—‘ï¸ ${REMOVED} removed",
                  "inline": false
                },
                {
                  "name": "ðŸ·ï¸ Version",
                  "value": "\`${VERSION}\`",
                  "inline": true
                },
                {
                  "name": "ðŸ”— Commit",
                  "value": "\`${SHORT_SHA}\`",
                  "inline": true
                },
                {
                  "name": "ðŸŒ¿ Branch",
                  "value": "\`${BRANCH}\`",
                  "inline": true
                },
                {
                  "name": "ðŸ‘¤ Pushed by",
                  "value": "${AUTHOR}",
                  "inline": true
                },
                {
                  "name": "ðŸ“Š Commits",
                  "value": "\`${COMMIT_COUNT}\`",
                  "inline": true
                }
              ],
              "footer": {
                "text": "Binxix Hub Updates  â€¢  ${REPO}"
              },
              "timestamp": "${TIMESTAMP}"
            }]
          }
          EOF
          )
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"
          
          echo "âœ… Discord notification sent!"
